@model EasyLearn.Models.ViewModels.PuzzlePlayViewModel
@{
    ViewData["Title"] = "Memory Game - " + Model.Game.Title;
}

<div class="container-fluid">
    @Html.AntiForgeryToken()
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="mb-0">ðŸ§  @Model.Game.Title</h3>
                    <p class="text-muted mb-0">Difficulty: <span class="badge badge-difficulty-@Model.Game.Difficulty.ToString().ToLower()">@Model.Game.Difficulty</span></p>
                </div>
                <div>
                    <a href="@Url.Action("Memory", "BrainGames")" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Memory Games
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Memory Match Game</h5>
                        <div>
                            <span class="badge bg-primary me-2">Matches: <span id="matches">0</span></span>
                            <span class="badge bg-info">Moves: <span id="moves">0</span></span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="memory-grid" class="memory-grid">
                        <!-- Cards will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Game Status</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary" id="score-display">@Model.Attempt.Score</h4>
                            <small class="text-muted">Score</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info" id="time-display">00:00</h4>
                            <small class="text-muted">Time</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h5 class="text-success" id="pairs-found">0</h5>
                            <small class="text-muted">Pairs Found</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-warning" id="total-pairs">4</h5>
                            <small class="text-muted">Total Pairs</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-question-circle"></i> How to Play</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Click cards to flip them over
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Find matching pairs of cards
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Match all pairs to win
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-brain text-info me-2"></i>
                            Use your memory to remember card positions!
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .memory-card:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .memory-card.flipped {
            background: white;
            color: #333;
            border-color: #007bff;
        }
        
        .memory-card.matched {
            background: #28a745;
            color: white;
            cursor: default;
        }
        
        .memory-card.matched:hover {
            transform: none;
        }
    </style>
    <script>
        let gameData = @Html.Raw(Json.Serialize(Model.GameState));
        let cards = gameData.cards || [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let startTime = Date.now();
        let timer;
        let currentScore = @Model.Attempt.Score;
        let maxScore = @Model.Game.MaxScore;
        let timeLimit = @Model.Game.TimeLimit;
        let attemptId = @Model.Attempt.Id;

        $(document).ready(function() {
            if (cards.length === 0) {
                cards = ['ðŸ”´', 'ðŸ”µ', 'ðŸŸ¢', 'ðŸŸ¡', 'ðŸ”´', 'ðŸ”µ', 'ðŸŸ¢', 'ðŸŸ¡'];
            }
            $('#total-pairs').text(cards.length / 2);
            shuffleCards();
            createGrid();
            startTimer();
        });

        function shuffleCards() {
            for (let i = cards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cards[i], cards[j]] = [cards[j], cards[i]];
            }
        }

        function createGrid() {
            const grid = $('#memory-grid');
            grid.empty();
            
            // Adjust grid columns based on number of cards
            const cols = Math.ceil(Math.sqrt(cards.length));
            grid.css('grid-template-columns', `repeat(${cols}, 1fr)`);
            
            cards.forEach((card, index) => {
                const cardElement = $('<div>')
                    .addClass('memory-card')
                    .attr('data-index', index)
                    .attr('data-value', card)
                    .text('?')
                    .click(() => flipCard(cardElement));
                
                grid.append(cardElement);
            });
        }

        function flipCard(cardElement) {
            if (cardElement.hasClass('flipped') || cardElement.hasClass('matched') || flippedCards.length >= 2) {
                return;
            }

            cardElement.addClass('flipped').text(cardElement.data('value'));
            flippedCards.push(cardElement);

            if (flippedCards.length === 2) {
                moves++;
                $('#moves').text(moves);
                
                setTimeout(checkMatch, 1000);
            }
        }

        function checkMatch() {
            const [card1, card2] = flippedCards;
            
            if (card1.data('value') === card2.data('value')) {
                card1.addClass('matched');
                card2.addClass('matched');
                matchedPairs++;
                
                // Calculate score based on pairs found and moves
                currentScore = Math.max(0, Math.floor((maxScore * matchedPairs) / (cards.length / 2) - (moves * 2)));
                
                $('#pairs-found').text(matchedPairs);
                $('#matches').text(matchedPairs);
                $('#score-display').text(currentScore);
                
                // Update server with progress
                updateGameProgress();
                
                if (matchedPairs === cards.length / 2) {
                    clearInterval(timer);
                    completeGame();
                }
            } else {
                card1.removeClass('flipped').text('?');
                card2.removeClass('flipped').text('?');
            }
            
            flippedCards = [];
        }

        function updateGameProgress() {
            const gameState = {
                cards: cards,
                matchedPairs: matchedPairs,
                moves: moves,
                score: currentScore
            };
            
            $.ajax({
                url: '@Url.Action("MakeMove", "BrainGames")',
                method: 'POST',
                data: JSON.stringify(gameState),
                contentType: 'application/json',
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                }
            });
        }

        function completeGame() {
            setTimeout(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeStr = minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
                
                Swal.fire({
                    title: 'ðŸŽ‰ Congratulations!',
                    html: `<div class="text-center">
                            <h4>Game Completed!</h4>
                            <p><strong>Score:</strong> ${currentScore} / ${maxScore}</p>
                            <p><strong>Time:</strong> ${timeStr}</p>
                            <p><strong>Moves:</strong> ${moves}</p>
                           </div>`,
                    icon: 'success',
                    confirmButtonText: 'View Results',
                    showCancelButton: true,
                    cancelButtonText: 'Play Again'
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.location.href = '@Url.Action("Result", "BrainGames", new { attemptId = Model.Attempt.Id })';
                    } else {
                        window.location.href = '@Url.Action("Memory", "BrainGames")';
                    }
                });
            }, 500);
        }

        function startTimer() {
            timer = setInterval(function() {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                $('#time-display').text(minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0'));
                
                // Check time limit
                if (timeLimit > 0 && elapsed >= timeLimit) {
                    clearInterval(timer);
                    Swal.fire({
                        title: 'â° Time\'s Up!',
                        text: 'The time limit has been reached.',
                        icon: 'warning',
                        confirmButtonText: 'View Results'
                    }).then(() => {
                        window.location.href = '@Url.Action("Result", "BrainGames", new { attemptId = Model.Attempt.Id })';
                    });
                }
            }, 1000);
        }
    </script>
}