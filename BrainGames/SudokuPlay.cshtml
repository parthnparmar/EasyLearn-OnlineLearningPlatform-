@model EasyLearn.Models.ViewModels.PuzzlePlayViewModel
@{
    ViewData["Title"] = "Sudoku - " + Model.Game.Title;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="mb-0">ðŸ”¢ @Model.Game.Title</h3>
                    <p class="text-muted mb-0">Difficulty: <span class="badge badge-difficulty-@Model.Game.Difficulty.ToString().ToLower()">@Model.Game.Difficulty</span></p>
                </div>
                <div>
                    <a href="@Url.Action("Sudoku", "BrainGames")" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Sudoku
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Game Area -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Sudoku Grid</h5>
                        <div class="game-controls">
                            <span class="badge bg-primary me-2">Score: <span id="current-score">@Model.Attempt.Score</span></span>
                            <span class="badge bg-info me-2">Moves: <span id="moves-count">@Model.Attempt.MovesCount</span></span>
                            @if (Model.Game.TimeLimit > 0)
                            {
                                <span class="badge bg-warning">Time: <span id="time-remaining">@TimeSpan.FromSeconds(Model.TimeRemaining).ToString(@"mm\:ss")</span></span>
                            }
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="sudoku-container">
                        <div id="sudoku-grid" class="sudoku-grid">
                            <!-- Sudoku grid will be generated by JavaScript -->
                        </div>
                        
                        <div class="number-selector mt-3">
                            <h6>Select Number:</h6>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-danger number-btn" data-number="0">
                                    <i class="fas fa-eraser"></i>
                                </button>
                                @for (int i = 1; i <= 9; i++)
                                {
                                    <button type="button" class="btn btn-outline-primary number-btn" data-number="@i">@i</button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Info & Controls -->
        <div class="col-lg-4">
            <!-- Game Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Game Status</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary" id="score-display">@Model.Attempt.Score</h4>
                            <small class="text-muted">Current Score</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info" id="time-display">00:00</h4>
                            <small class="text-muted">Time Elapsed</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h5 class="text-success" id="hints-remaining">@(Model.MaxHints - Model.Attempt.HintsUsed)</h5>
                            <small class="text-muted">Hints Left</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-warning" id="moves-display">@Model.Attempt.MovesCount</h5>
                            <small class="text-muted">Moves Made</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Controls -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-gamepad"></i> Game Controls</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" id="hint-btn">
                            <i class="fas fa-lightbulb"></i> Get Hint
                        </button>
                        <button type="button" class="btn btn-warning" id="validate-btn">
                            <i class="fas fa-check-circle"></i> Validate Grid
                        </button>
                        <button type="button" class="btn btn-info" id="clear-btn">
                            <i class="fas fa-broom"></i> Clear Selected
                        </button>
                        <hr>
                        <button type="button" class="btn btn-secondary" id="pause-btn">
                            <i class="fas fa-pause"></i> Pause Game
                        </button>
                        <button type="button" class="btn btn-danger" id="abandon-btn">
                            <i class="fas fa-times"></i> Abandon Game
                        </button>
                    </div>
                </div>
            </div>

            <!-- How to Play -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-question-circle"></i> How to Play</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Fill each row with numbers 1-9
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Fill each column with numbers 1-9
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Fill each 3Ã—3 box with numbers 1-9
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            No number can repeat in any row, column, or box
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-lightbulb text-warning me-2"></i>
                            Use hints sparingly - they reduce your score!
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="~/css/brain-games.css" />
    <script>
        let selectedNumber = 1;
        let selectedCell = null;
        let gameState = {};
        let attemptId = @Model.Attempt.Id;
        let timeRemaining = @Model.TimeRemaining;
        let gameTimer;
        let elapsedTimer;
        let isPaused = false;

        $(document).ready(function() {
            // Initialize with sample grid
            gameState = {
                Grid: [
                    [5,3,0,0,7,0,0,0,0],
                    [6,0,0,1,9,5,0,0,0],
                    [0,9,8,0,0,0,0,6,0],
                    [8,0,0,0,6,0,0,0,3],
                    [4,0,0,8,0,3,0,0,1],
                    [7,0,0,0,2,0,0,0,6],
                    [0,6,0,0,0,0,2,8,0],
                    [0,0,0,4,1,9,0,0,5],
                    [0,0,0,0,8,0,0,7,9]
                ],
                IsFixed: [
                    [true,true,false,false,true,false,false,false,false],
                    [true,false,false,true,true,true,false,false,false],
                    [false,true,true,false,false,false,false,true,false],
                    [true,false,false,false,true,false,false,false,true],
                    [true,false,false,true,false,true,false,false,true],
                    [true,false,false,false,true,false,false,false,true],
                    [false,true,false,false,false,false,true,true,false],
                    [false,false,false,true,true,true,false,false,true],
                    [false,false,false,false,true,false,false,true,true]
                ]
            };
            
            initializeSudokuGrid();
            startTimers();
            bindEvents();
        });

        function initializeSudokuGrid() {
            const grid = $('#sudoku-grid');
            grid.empty();

            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = $('<div>')
                        .addClass('sudoku-cell')
                        .attr('data-row', row)
                        .attr('data-col', col)
                        .text(gameState.Grid[row][col] !== 0 ? gameState.Grid[row][col] : '');

                    if (row % 3 === 0 && row !== 0) cell.addClass('border-top-thick');
                    if (col % 3 === 0 && col !== 0) cell.addClass('border-left-thick');

                    if (gameState.IsFixed[row][col]) {
                        cell.addClass('fixed-cell');
                    }

                    grid.append(cell);
                }
            }
        }

        function bindEvents() {
            $(document).on('click', '.sudoku-cell:not(.fixed-cell)', function() {
                $('.sudoku-cell').removeClass('selected');
                $(this).addClass('selected');
                selectedCell = $(this);
            });

            $('.number-btn').click(function() {
                $('.number-btn').removeClass('active');
                $(this).addClass('active');
                selectedNumber = parseInt($(this).data('number'));
                
                if (selectedCell) {
                    makeMove(selectedCell, selectedNumber);
                }
            });

            $('#hint-btn').click(getHint);
            $('#validate-btn').click(validateGrid);
            $('#clear-btn').click(clearSelected);
            $('#pause-btn').click(pauseGame);
            $('#abandon-btn').click(abandonGame);
        }

        function makeMove(cell, number) {
            const row = parseInt(cell.data('row'));
            const col = parseInt(cell.data('col'));
            
            if (validateMove(row, col, number)) {
                cell.text(number === 0 ? '' : number);
                gameState.Grid[row][col] = number;
                updateMoveCount();
                checkCompletion();
            } else if (number !== 0) {
                Swal.fire({
                    title: 'Invalid Move!',
                    text: 'This number conflicts with Sudoku rules.',
                    icon: 'error',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        }

        function validateMove(row, col, number) {
            if (number === 0) return true;
            
            // Check row
            for (let c = 0; c < 9; c++) {
                if (c !== col && gameState.Grid[row][c] === number) return false;
            }
            
            // Check column
            for (let r = 0; r < 9; r++) {
                if (r !== row && gameState.Grid[r][col] === number) return false;
            }
            
            // Check 3x3 box
            const boxRow = Math.floor(row / 3) * 3;
            const boxCol = Math.floor(col / 3) * 3;
            for (let r = boxRow; r < boxRow + 3; r++) {
                for (let c = boxCol; c < boxCol + 3; c++) {
                    if ((r !== row || c !== col) && gameState.Grid[r][c] === number) return false;
                }
            }
            
            return true;
        }

        function checkCompletion() {
            let completed = true;
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    if (gameState.Grid[row][col] === 0) {
                        completed = false;
                        break;
                    }
                }
                if (!completed) break;
            }
            
            if (completed) {
                Swal.fire({
                    title: 'ðŸŽ‰ Congratulations!',
                    text: 'You completed the Sudoku puzzle!',
                    icon: 'success',
                    confirmButtonText: 'View Results'
                }).then(() => {
                    window.location.href = '@Url.Action("Result", "BrainGames", new { attemptId = Model.Attempt.Id })';
                });
            }
        }

        function getHint() {
            if (@Model.Attempt.HintsUsed >= @Model.MaxHints) {
                Swal.fire('No Hints Left!', 'You have used all available hints.', 'warning');
                return;
            }
            
            Swal.fire({
                title: 'ðŸ’¡ Hint',
                text: 'Look for cells where only one number can fit based on the row, column, and box constraints!',
                icon: 'info',
                confirmButtonText: 'Got it!'
            });
        }

        function validateGrid() {
            let errors = 0;
            $('.sudoku-cell').removeClass('error');
            
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const value = gameState.Grid[row][col];
                    if (value !== 0) {
                        gameState.Grid[row][col] = 0; // Temporarily remove to check
                        if (!validateMove(row, col, value)) {
                            $(`.sudoku-cell[data-row="${row}"][data-col="${col}"]`).addClass('error');
                            errors++;
                        }
                        gameState.Grid[row][col] = value; // Restore
                    }
                }
            }
            
            if (errors === 0) {
                Swal.fire('Great!', 'No errors found in your current solution!', 'success');
            } else {
                Swal.fire('Errors Found', `Found ${errors} error(s) highlighted in red.`, 'warning');
            }
        }

        function clearSelected() {
            if (selectedCell && !selectedCell.hasClass('fixed-cell')) {
                makeMove(selectedCell, 0);
            }
        }

        function pauseGame() {
            isPaused = !isPaused;
            if (isPaused) {
                clearInterval(elapsedTimer);
                $('#pause-btn').html('<i class="fas fa-play"></i> Resume Game');
                $('.sudoku-grid').addClass('paused');
            } else {
                startTimers();
                $('#pause-btn').html('<i class="fas fa-pause"></i> Pause Game');
                $('.sudoku-grid').removeClass('paused');
            }
        }

        function abandonGame() {
            Swal.fire({
                title: 'Abandon Game?',
                text: 'Are you sure you want to abandon this game? Your progress will be lost.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, abandon',
                cancelButtonText: 'Continue playing'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '@Url.Action("Sudoku", "BrainGames")';
                }
            });
        }

        function updateMoveCount() {
            const currentMoves = parseInt($('#moves-display').text()) + 1;
            $('#moves-display').text(currentMoves);
            $('#moves-count').text(currentMoves);
        }

        function startTimers() {
            let elapsed = 0;
            elapsedTimer = setInterval(function() {
                if (!isPaused) {
                    elapsed++;
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    $('#time-display').text(minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0'));
                }
            }, 1000);
        }
    </script>
}

@Html.AntiForgeryToken()