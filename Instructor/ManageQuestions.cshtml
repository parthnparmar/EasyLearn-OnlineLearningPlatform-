@model Quiz
@{
    ViewData["Title"] = "Manage Questions - " + Model.Title;
}

@Html.AntiForgeryToken()

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-question-circle text-primary"></i> Manage Questions</h2>
                    <p class="text-muted mb-0">Quiz: <strong>@Model.Title</strong></p>
                    <p class="text-muted">Course: <strong>@Model.Course.Title</strong></p>
                </div>
                <div>
                    <a href="@Url.Action("ManageQuizzes", new { courseId = Model.CourseId })" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Quizzes
                    </a>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                        <i class="fas fa-plus"></i> Add Question
                    </button>
                </div>
            </div>

            @if (TempData["Success"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @TempData["Success"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Questions (@Model.Questions.Count)
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.Questions.Any())
                    {
                        <div class="row">
                            @foreach (var question in Model.Questions.OrderBy(q => q.Id))
                            {
                                <div class="col-md-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span class="badge bg-primary">@question.Type</span>
                                            <span class="text-muted">@question.Points pts</span>
                                        </div>
                                        <div class="card-body">
                                            <h6 class="card-title">@question.Text</h6>
                                            
                                            @if (question.Answers.Any())
                                            {
                                                <div class="mt-3">
                                                    <small class="text-muted d-block mb-2">Answer Options:</small>
                                                    @foreach (var answer in question.Answers)
                                                    {
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="@(question.Type == QuestionType.MultipleChoice ? "radio" : "checkbox")" disabled @(answer.IsCorrect ? "checked" : "")>
                                                            <label class="form-check-label @(answer.IsCorrect ? "text-success fw-bold" : "")">
                                                                @answer.Text
                                                                @if (answer.IsCorrect)
                                                                {
                                                                    <i class="fas fa-check text-success ms-1"></i>
                                                                }
                                                            </label>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <div class="card-footer">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editQuestion(@question.Id)">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteQuestion(@question.Id)">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-question-circle fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No questions added yet</h5>
                            <p class="text-muted">Start by adding your first question to this quiz.</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                                <i class="fas fa-plus"></i> Add First Question
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Question Modal -->
<div class="modal fade" id="addQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="CreateQuestion" method="post" id="questionForm">
                <input type="hidden" name="QuizId" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title">Add New Question</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Question Type</label>
                        <select name="Type" class="form-select" id="questionType" onchange="toggleAnswerOptions()">
                            <option value="@((int)QuestionType.MultipleChoice)">Multiple Choice</option>
                            <option value="@((int)QuestionType.TrueFalse)">True/False</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea name="Text" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Points</label>
                        <input type="number" name="Points" class="form-control" value="1" min="1" max="10" required />
                    </div>
                    
                    <div id="answerOptions">
                        <label class="form-label">Answer Options</label>
                        <div id="multipleChoiceAnswers">
                            <div class="mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="correctAnswer" value="0" checked>
                                    </div>
                                    <input type="text" name="answerTexts" class="form-control" placeholder="Option A" required>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="correctAnswer" value="1">
                                    </div>
                                    <input type="text" name="answerTexts" class="form-control" placeholder="Option B" required>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="correctAnswer" value="2">
                                    </div>
                                    <input type="text" name="answerTexts" class="form-control" placeholder="Option C">
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="correctAnswer" value="3">
                                    </div>
                                    <input type="text" name="answerTexts" class="form-control" placeholder="Option D">
                                </div>
                            </div>
                        </div>
                        
                        <div id="trueFalseAnswers" style="display: none;">
                            <div class="mb-2">
                                <div class="form-check">
                                    <input type="radio" name="trueFalseCorrect" value="True" class="form-check-input" id="trueOption" checked>
                                    <label class="form-check-label" for="trueOption">True</label>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="form-check">
                                    <input type="radio" name="trueFalseCorrect" value="False" class="form-check-input" id="falseOption">
                                    <label class="form-check-label" for="falseOption">False</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Question</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Question Modal -->
<div class="modal fade" id="editQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="UpdateQuestion" method="post" id="editQuestionForm">
                <input type="hidden" name="Id" id="editQuestionId" />
                <div class="modal-header">
                    <h5 class="modal-title">Edit Question</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Question Type</label>
                        <select name="Type" class="form-select" id="editQuestionType" onchange="toggleEditAnswerOptions()">
                            <option value="@((int)QuestionType.MultipleChoice)">Multiple Choice</option>
                            <option value="@((int)QuestionType.TrueFalse)">True/False</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Question Text</label>
                        <textarea name="Text" id="editQuestionText" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Points</label>
                        <input type="number" name="Points" id="editQuestionPoints" class="form-control" value="1" min="1" max="10" required />
                    </div>
                    
                    <div id="editAnswerOptions">
                        <label class="form-label">Answer Options</label>
                        <div id="editMultipleChoiceAnswers">
                            <div class="mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="editCorrectAnswer" value="0">
                                    </div>
                                    <input type="text" name="answerTexts" class="form-control" placeholder="Option A" required>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="editCorrectAnswer" value="1">
                                    </div>
                                    <input type="text" name="answerTexts" class="form-control" placeholder="Option B" required>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="editCorrectAnswer" value="2">
                                    </div>
                                    <input type="text" name="answerTexts" class="form-control" placeholder="Option C">
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="input-group">
                                    <div class="input-group-text">
                                        <input type="radio" name="editCorrectAnswer" value="3">
                                    </div>
                                    <input type="text" name="answerTexts" class="form-control" placeholder="Option D">
                                </div>
                            </div>
                        </div>
                        
                        <div id="editTrueFalseAnswers" style="display: none;">
                            <div class="mb-2">
                                <div class="form-check">
                                    <input type="radio" name="trueFalseCorrect" value="True" class="form-check-input" id="editTrueOption">
                                    <label class="form-check-label" for="editTrueOption">True</label>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="form-check">
                                    <input type="radio" name="trueFalseCorrect" value="False" class="form-check-input" id="editFalseOption">
                                    <label class="form-check-label" for="editFalseOption">False</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Question</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleAnswerOptions() {
    const questionType = document.getElementById('questionType').value;
    const multipleChoice = document.getElementById('multipleChoiceAnswers');
    const trueFalse = document.getElementById('trueFalseAnswers');
    
    if (questionType == '@((int)QuestionType.TrueFalse)') {
        multipleChoice.style.display = 'none';
        trueFalse.style.display = 'block';
        // Remove required attribute from multiple choice inputs
        multipleChoice.querySelectorAll('input[required]').forEach(input => input.removeAttribute('required'));
    } else {
        multipleChoice.style.display = 'block';
        trueFalse.style.display = 'none';
        // Add required attribute to first two multiple choice inputs
        const requiredInputs = multipleChoice.querySelectorAll('input[name="answerTexts"]');
        requiredInputs[0].setAttribute('required', 'required');
        requiredInputs[1].setAttribute('required', 'required');
    }
}

function toggleEditAnswerOptions() {
    const questionType = document.getElementById('editQuestionType').value;
    const multipleChoice = document.getElementById('editMultipleChoiceAnswers');
    const trueFalse = document.getElementById('editTrueFalseAnswers');
    
    if (questionType == '@((int)QuestionType.TrueFalse)') {
        multipleChoice.style.display = 'none';
        trueFalse.style.display = 'block';
        // Remove required attribute from multiple choice inputs
        multipleChoice.querySelectorAll('input[required]').forEach(input => input.removeAttribute('required'));
    } else {
        multipleChoice.style.display = 'block';
        trueFalse.style.display = 'none';
        // Add required attribute to first two multiple choice inputs
        const requiredInputs = multipleChoice.querySelectorAll('input[name="answerTexts"]');
        requiredInputs[0].setAttribute('required', 'required');
        requiredInputs[1].setAttribute('required', 'required');
    }
}

// Handle correct answer selection for multiple choice
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('questionForm');
    const editForm = document.getElementById('editQuestionForm');
    
    form.addEventListener('submit', function(e) {
        const questionType = document.getElementById('questionType').value;
        
        if (questionType == '@((int)QuestionType.MultipleChoice)') {
            // Add hidden inputs for correct answers
            const correctAnswerIndex = document.querySelector('input[name="correctAnswer"]:checked').value;
            const answerInputs = document.querySelectorAll('#multipleChoiceAnswers input[name="answerTexts"]');
            
            answerInputs.forEach((input, index) => {
                if (input.value.trim()) {
                    const isCorrect = index == correctAnswerIndex;
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'isCorrectAnswers';
                    hiddenInput.value = isCorrect;
                    form.appendChild(hiddenInput);
                }
            });
        }
    });
    
    editForm.addEventListener('submit', function(e) {
        const questionType = document.getElementById('editQuestionType').value;
        
        if (questionType == '@((int)QuestionType.MultipleChoice)') {
            // Add hidden inputs for correct answers
            const correctAnswerIndex = document.querySelector('input[name="editCorrectAnswer"]:checked').value;
            const answerInputs = document.querySelectorAll('#editMultipleChoiceAnswers input[name="answerTexts"]');
            
            answerInputs.forEach((input, index) => {
                if (input.value.trim()) {
                    const isCorrect = index == correctAnswerIndex;
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'isCorrectAnswers';
                    hiddenInput.value = isCorrect;
                    editForm.appendChild(hiddenInput);
                }
            });
        }
    });
});

async function editQuestion(questionId) {
    try {
        const response = await fetch(`/instructor/get-question/${questionId}`);
        const question = await response.json();
        
        if (!question) {
            alert('Question not found');
            return;
        }
        
        // Populate edit form
        document.getElementById('editQuestionId').value = question.id;
        document.getElementById('editQuestionText').value = question.text;
        document.getElementById('editQuestionType').value = question.type;
        document.getElementById('editQuestionPoints').value = question.points;
        
        // Clear previous answer inputs
        const answerInputs = document.querySelectorAll('#editMultipleChoiceAnswers input[name="answerTexts"]');
        answerInputs.forEach(input => input.value = '');
        
        if (question.type == @((int)QuestionType.TrueFalse)) {
            // True/False question
            const correctAnswer = question.answers.find(a => a.isCorrect);
            if (correctAnswer) {
                const radioButton = document.querySelector(`input[name="trueFalseCorrect"][value="${correctAnswer.text}"]`);
                if (radioButton) radioButton.checked = true;
            }
        } else {
            // Multiple choice question
            question.answers.forEach((answer, index) => {
                if (index < answerInputs.length) {
                    answerInputs[index].value = answer.text;
                    if (answer.isCorrect) {
                        document.querySelector(`input[name="editCorrectAnswer"][value="${index}"]`).checked = true;
                    }
                }
            });
        }
        
        toggleEditAnswerOptions();
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editQuestionModal'));
        modal.show();
    } catch (error) {
        console.error('Error loading question:', error);
        alert('Error loading question data');
    }
}

async function deleteQuestion(questionId) {
    if (confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
        try {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            
            const response = await fetch(`/instructor/delete-question/${questionId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                location.reload();
            } else {
                alert(result.message || 'Error deleting question');
            }
        } catch (error) {
            console.error('Error deleting question:', error);
            alert('Error deleting question');
        }
    }
}
</script>