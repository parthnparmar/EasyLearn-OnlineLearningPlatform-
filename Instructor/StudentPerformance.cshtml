@model List<EasyLearn.Models.Enrollment>
@{
    ViewData["Title"] = "Student Performance";
    Layout = "_Layout";
    var course = ViewBag.Course as EasyLearn.Models.Course;
    var quizResults = ViewBag.QuizResults as List<dynamic> ?? new List<dynamic>();
    var lessonProgress = ViewBag.LessonProgress as List<dynamic> ?? new List<dynamic>();
}

<link href="~/css/instructor-dashboard.css" rel="stylesheet" />

<div class="student-performance">
    <div class="container-fluid">
        <!-- Header -->
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/instructor">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="/instructor/my-courses">My Courses</a></li>
                            <li class="breadcrumb-item active">@(course?.Title ?? "Course")</li>
                        </ol>
                    </nav>
                    <h1 class="page-title">
                        <i class="fas fa-chart-bar"></i>
                        Student Performance
                    </h1>
                    <p class="page-subtitle">Course: @(course?.Title ?? "Unknown Course")</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-outline-primary" onclick="exportPerformanceData()">
                        <i class="fas fa-download"></i>
                        Export Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Performance Overview -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stats-card gradient-primary">
                    <div class="stats-content">
                        <div class="stats-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stats-info">
                            <div class="stats-number">@(Model?.Count ?? 0)</div>
                            <div class="stats-label">Total Students</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stats-card gradient-success">
                    <div class="stats-content">
                        <div class="stats-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="stats-info">
                            <div class="stats-number">@(Model?.Count(e => e.IsCompleted) ?? 0)</div>
                            <div class="stats-label">Completed</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stats-card gradient-info">
                    <div class="stats-content">
                        <div class="stats-icon">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="stats-info">
                            <div class="stats-number">@(Model?.Any() == true ? ((double)Model.Count(e => e.IsCompleted) / Model.Count * 100).ToString("F1") : "0")%</div>
                            <div class="stats-label">Completion Rate</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="stats-card gradient-warning">
                    <div class="stats-content">
                        <div class="stats-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stats-info">
                            <div class="stats-number">@(Model?.Any() == true ? Model.Average(e => e.ProgressPercentage).ToString("F1") : "0")%</div>
                            <div class="stats-label">Avg Progress</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Performance Table -->
        <div class="row">
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h5 class="card-title">
                            <i class="fas fa-table"></i>
                            Student Performance Details
                        </h5>
                        <div class="card-actions">
                            <div class="input-group input-group-sm" style="width: 250px;">
                                <input type="text" class="form-control" placeholder="Search students..." id="studentSearch">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (Model?.Any() == true)
                        {
                            <div class="table-responsive">
                                <table class="table table-hover" id="performanceTable">
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Enrolled Date</th>
                                            <th>Progress</th>
                                            <th>Lessons Completed</th>
                                            <th>Quiz Performance</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var enrollment in Model)
                                        {
                                            var studentQuizData = quizResults.FirstOrDefault(q => q.StudentId == enrollment.StudentId);
                                            var studentLessonData = lessonProgress.FirstOrDefault(l => l.StudentId == enrollment.StudentId);
                                            
                                            <tr>
                                                <td>
                                                    <div class="student-info">
                                                        <div class="student-avatar">
                                                            @(enrollment.Student?.FirstName?.FirstOrDefault() ?? 'U')@(enrollment.Student?.LastName?.FirstOrDefault() ?? 'U')
                                                        </div>
                                                        <div class="student-details">
                                                            <strong>@(enrollment.Student?.FirstName ?? "Unknown") @(enrollment.Student?.LastName ?? "User")</strong>
                                                            <small class="text-muted d-block">@(enrollment.Student?.Email ?? "No email")</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="enrollment-date">@enrollment.EnrolledAt.ToString("MMM dd, yyyy")</span>
                                                    <small class="text-muted d-block">@enrollment.EnrolledAt.ToString("HH:mm")</small>
                                                </td>
                                                <td>
                                                    <div class="progress-container">
                                                        <div class="progress" style="height: 8px;">
                                                            <div class="progress-bar bg-success" style="width: @enrollment.ProgressPercentage%"></div>
                                                        </div>
                                                        <small class="progress-text">@enrollment.ProgressPercentage.ToString("F1")%</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    @if (studentLessonData != null)
                                                    {
                                                        <span class="lesson-progress">
                                                            @studentLessonData.CompletedLessons / @studentLessonData.TotalLessons
                                                        </span>
                                                        <small class="text-muted d-block">
                                                            @(studentLessonData.TotalLessons > 0 ? ((double)studentLessonData.CompletedLessons / studentLessonData.TotalLessons * 100).ToString("F0") : "0")% complete
                                                        </small>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">No progress</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (studentQuizData != null)
                                                    {
                                                        <div class="quiz-performance">
                                                            <span class="quiz-score badge bg-@(studentQuizData.AverageScore >= 70 ? "success" : "warning")">
                                                                @studentQuizData.AverageScore.ToString("F1")%
                                                            </span>
                                                            <small class="text-muted d-block">@studentQuizData.AttemptCount attempts</small>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">No attempts</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (enrollment.IsCompleted)
                                                    {
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-check"></i>
                                                            Completed
                                                        </span>
                                                        @if (enrollment.CompletedAt.HasValue)
                                                        {
                                                            <small class="text-muted d-block">@enrollment.CompletedAt.Value.ToString("MMM dd, yyyy")</small>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-primary">
                                                            <i class="fas fa-play"></i>
                                                            In Progress
                                                        </span>
                                                    }
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary" onclick="viewStudentDetails('@enrollment.StudentId')" title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-outline-info" onclick="sendMessage('@enrollment.StudentId')" title="Send Message">
                                                            <i class="fas fa-envelope"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <div class="empty-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h6>No students enrolled</h6>
                                <p>Students will appear here once they enroll in your course</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Analytics -->
        @if (Model?.Any() == true)
        {
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-chart-pie"></i>
                                Completion Status
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="completionChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <h5 class="card-title">
                                <i class="fas fa-chart-line"></i>
                                Progress Distribution
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="progressChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Student Details Modal -->
<div class="modal fade" id="studentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user"></i>
                    Student Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="studentDetailsContent">
                <!-- Student details will be loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Search functionality
        document.getElementById('studentSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#performanceTable tbody tr');
            
            rows.forEach(row => {
                const studentName = row.querySelector('.student-details strong').textContent.toLowerCase();
                const studentEmail = row.querySelector('.student-details small').textContent.toLowerCase();
                
                if (studentName.includes(searchTerm) || studentEmail.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Charts
        @if (Model?.Any() == true)
        {
            <text>
            // Completion Status Chart
            const completionCtx = document.getElementById('completionChart').getContext('2d');
            const completedCount = @Model.Count(e => e.IsCompleted);
            const inProgressCount = @Model.Count - completedCount;
            
            new Chart(completionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress'],
                    datasets: [{
                        data: [completedCount, inProgressCount],
                        backgroundColor: ['#28a745', '#007bff'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Progress Distribution Chart
            const progressCtx = document.getElementById('progressChart').getContext('2d');
            const progressRanges = [
                { label: '0-25%', count: @Model.Count(e => e.ProgressPercentage >= 0 && e.ProgressPercentage < 25) },
                { label: '25-50%', count: @Model.Count(e => e.ProgressPercentage >= 25 && e.ProgressPercentage < 50) },
                { label: '50-75%', count: @Model.Count(e => e.ProgressPercentage >= 50 && e.ProgressPercentage < 75) },
                { label: '75-100%', count: @Model.Count(e => e.ProgressPercentage >= 75) }
            ];
            
            new Chart(progressCtx, {
                type: 'bar',
                data: {
                    labels: progressRanges.map(r => r.label),
                    datasets: [{
                        label: 'Students',
                        data: progressRanges.map(r => r.count),
                        backgroundColor: '#007bff',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            </text>
        }

        function viewStudentDetails(studentId) {
            // Load student details via AJAX
            fetch(`/instructor/student-details/${studentId}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('studentDetailsContent').innerHTML = html;
                    new bootstrap.Modal(document.getElementById('studentDetailsModal')).show();
                })
                .catch(error => {
                    console.error('Error loading student details:', error);
                });
        }

        function sendMessage(studentId) {
            // Implement messaging functionality
            alert('Messaging feature coming soon!');
        }

        function exportPerformanceData() {
            // Export performance data to CSV
            window.location.href = `/instructor/export-performance/@(course?.Id ?? 0)`;
        }
    </script>
}