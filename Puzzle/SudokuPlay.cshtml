@model EasyLearn.Models.ViewModels.PuzzlePlayViewModel
@{
    ViewData["Title"] = "Sudoku - " + Model.Game.Title;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="mb-0">ðŸ”¢ @Model.Game.Title</h3>
                    <p class="text-muted mb-0">Difficulty: <span class="badge badge-difficulty-@Model.Game.Difficulty.ToString().ToLower()">@Model.Game.Difficulty</span></p>
                </div>
                <div>
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Games
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Game Area -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Sudoku Grid</h5>
                        <div class="game-controls">
                            <span class="badge bg-primary me-2">Score: <span id="current-score">@Model.Attempt.Score</span></span>
                            <span class="badge bg-info me-2">Moves: <span id="moves-count">@Model.Attempt.MovesCount</span></span>
                            @if (Model.Game.TimeLimit > 0)
                            {
                                <span class="badge bg-warning">Time: <span id="time-remaining">@TimeSpan.FromSeconds(Model.TimeRemaining).ToString(@"mm\:ss")</span></span>
                            }
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="sudoku-container">
                        <div id="sudoku-grid" class="sudoku-grid">
                            <!-- Sudoku grid will be generated by JavaScript -->
                        </div>
                        
                        <div class="number-selector mt-3">
                            <h6>Select Number:</h6>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary number-btn" data-number="0">
                                    <i class="fas fa-eraser"></i>
                                </button>
                                @for (int i = 1; i <= 9; i++)
                                {
                                    <button type="button" class="btn btn-outline-primary number-btn" data-number="@i">@i</button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Info & Controls -->
        <div class="col-lg-4">
            <!-- Game Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Game Status</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary" id="score-display">@Model.Attempt.Score</h4>
                            <small class="text-muted">Current Score</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-info" id="time-display">00:00</h4>
                            <small class="text-muted">Time Elapsed</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-6">
                            <h5 class="text-success" id="hints-remaining">@(Model.MaxHints - Model.Attempt.HintsUsed)</h5>
                            <small class="text-muted">Hints Left</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-warning" id="moves-display">@Model.Attempt.MovesCount</h5>
                            <small class="text-muted">Moves Made</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Controls -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-gamepad"></i> Game Controls</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success" id="hint-btn">
                            <i class="fas fa-lightbulb"></i> Get Hint
                        </button>
                        <button type="button" class="btn btn-warning" id="validate-btn">
                            <i class="fas fa-check-circle"></i> Validate Grid
                        </button>
                        <button type="button" class="btn btn-info" id="autosolve-btn">
                            <i class="fas fa-magic"></i> Auto Solve
                        </button>
                        <hr>
                        <button type="button" class="btn btn-danger" id="abandon-btn">
                            <i class="fas fa-times"></i> Abandon Game
                        </button>
                    </div>
                </div>
            </div>

            <!-- How to Play -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-question-circle"></i> How to Play</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Fill each row with numbers 1-9
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Fill each column with numbers 1-9
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Fill each 3Ã—3 box with numbers 1-9
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            No number can repeat in any row, column, or box
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-lightbulb text-warning me-2"></i>
                            Use hints sparingly - they reduce your score!
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let selectedNumber = 1;
        let selectedCell = null;
        let gameState = {};
        let attemptId = @Model.Attempt.Id;
        let timeRemaining = @Model.TimeRemaining;
        let gameTimer;
        let elapsedTimer;

        $(document).ready(function() {
            // Initialize with a simple grid for demo
            gameState = {
                Grid: [
                    [5,3,0,0,7,0,0,0,0],
                    [6,0,0,1,9,5,0,0,0],
                    [0,9,8,0,0,0,0,6,0],
                    [8,0,0,0,6,0,0,0,3],
                    [4,0,0,8,0,3,0,0,1],
                    [7,0,0,0,2,0,0,0,6],
                    [0,6,0,0,0,0,2,8,0],
                    [0,0,0,4,1,9,0,0,5],
                    [0,0,0,0,8,0,0,7,9]
                ],
                IsFixed: [
                    [true,true,false,false,true,false,false,false,false],
                    [true,false,false,true,true,true,false,false,false],
                    [false,true,true,false,false,false,false,true,false],
                    [true,false,false,false,true,false,false,false,true],
                    [true,false,false,true,false,true,false,false,true],
                    [true,false,false,false,true,false,false,false,true],
                    [false,true,false,false,false,false,true,true,false],
                    [false,false,false,true,true,true,false,false,true],
                    [false,false,false,false,true,false,false,true,true]
                ]
            };
            
            initializeSudokuGrid();
            startTimers();
            bindEvents();
        });

        function initializeSudokuGrid() {
            const grid = $('#sudoku-grid');
            grid.empty();

            // Create 9x9 grid
            for (let row = 0; row < 9; row++) {
                for (let col = 0; col < 9; col++) {
                    const cell = $('<div>')
                        .addClass('sudoku-cell')
                        .attr('data-row', row)
                        .attr('data-col', col)
                        .text(gameState.Grid[row][col] !== 0 ? gameState.Grid[row][col] : '');

                    // Add box borders
                    if (row % 3 === 0 && row !== 0) cell.addClass('border-top-thick');
                    if (col % 3 === 0 && col !== 0) cell.addClass('border-left-thick');

                    // Mark fixed cells
                    if (gameState.IsFixed[row][col]) {
                        cell.addClass('fixed-cell');
                    }

                    grid.append(cell);
                }
            }
        }

        function bindEvents() {
            // Cell selection
            $(document).on('click', '.sudoku-cell:not(.fixed-cell)', function() {
                $('.sudoku-cell').removeClass('selected');
                $(this).addClass('selected');
                selectedCell = $(this);
            });

            // Number selection
            $('.number-btn').click(function() {
                $('.number-btn').removeClass('active');
                $(this).addClass('active');
                selectedNumber = parseInt($(this).data('number'));
                
                if (selectedCell) {
                    makeMove(selectedCell, selectedNumber);
                }
            });

            // Game controls
            $('#hint-btn').click(getHint);
            $('#validate-btn').click(validateGrid);
            $('#autosolve-btn').click(autoSolve);
            $('#abandon-btn').click(abandonGame);
        }

        function makeMove(cell, number) {
            cell.text(number === 0 ? '' : number);
            updateMoveCount();
        }

        function getHint() {
            Swal.fire({
                title: 'ðŸ’¡ Hint',
                text: 'Look for cells with only one possible number!',
                icon: 'info',
                confirmButtonText: 'Got it!'
            });
        }

        function autoSolve() {
            if (confirm('Are you sure you want to auto-solve? This will end the game with no score.')) {
                Swal.fire('Auto-solved!', 'The puzzle has been completed automatically.', 'info');
            }
        }

        function abandonGame() {
            if (confirm('Are you sure you want to abandon this game?')) {
                window.location.href = '@Url.Action("Index")';
            }
        }

        function validateGrid() {
            Swal.fire('Validation Complete', 'Grid looks good so far!', 'success');
        }

        function updateMoveCount() {
            const currentMoves = parseInt($('#moves-display').text()) + 1;
            $('#moves-display').text(currentMoves);
            $('#moves-count').text(currentMoves);
        }

        function startTimers() {
            let elapsed = 0;
            elapsedTimer = setInterval(function() {
                elapsed++;
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                $('#time-display').text(minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0'));
            }, 1000);
        }
    </script>

    <style>
        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            gap: 1px;
            background-color: #000;
            border: 3px solid #000;
            max-width: 450px;
            margin: 0 auto;
            aspect-ratio: 1;
        }

        .sudoku-cell {
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 45px;
        }

        .sudoku-cell:hover:not(.fixed-cell) {
            background-color: #e3f2fd;
        }

        .sudoku-cell.selected {
            background-color: #2196f3;
            color: white;
        }

        .sudoku-cell.fixed-cell {
            background-color: #f5f5f5;
            color: #333;
            cursor: not-allowed;
        }

        .border-top-thick {
            border-top: 3px solid #000 !important;
        }

        .border-left-thick {
            border-left: 3px solid #000 !important;
        }

        .number-selector .btn {
            min-width: 45px;
        }

        .badge-difficulty-easy {
            background-color: #28a745;
        }
        
        .badge-difficulty-medium {
            background-color: #ffc107;
            color: #000;
        }
        
        .badge-difficulty-hard {
            background-color: #fd7e14;
        }
        
        .badge-difficulty-expert {
            background-color: #dc3545;
        }

        @@media (max-width: 768px) {
            .sudoku-grid {
                max-width: 300px;
            }
            
            .sudoku-cell {
                font-size: 1rem;
                min-height: 30px;
            }
        }
    </style>
}

@Html.AntiForgeryToken()